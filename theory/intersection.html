<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IntersectionObserver - Interview Example (4 Years Exp)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #fff;
      line-height: 1.6;
    }

    /* Sticky Header with Observer */
    .header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 20px;
      background: transparent;
      transition: all 0.3s ease;
      z-index: 100;
    }

    .header.scrolled {
      background: rgba(26, 26, 46, 0.95);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
      padding: 10px 20px;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #00d9ff;
    }

    /* Sentinel for header detection */
    .header-sentinel {
      height: 1px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 100px 20px 20px;
    }

    /* Product Cards with Lazy Load + Animation */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .product-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      overflow: hidden;
      opacity: 0;
      transform: translateY(40px);
      transition: all 0.6s ease;
    }

    .product-card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .product-image {
      height: 180px;
      background: linear-gradient(135deg, #2a2a4a, #1a1a2e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      position: relative;
    }

    .product-image.loaded {
      background: linear-gradient(135deg, #00d9ff, #0099cc);
    }

    .product-image .loader {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #00d9ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .product-image.loaded .loader {
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .product-info {
      padding: 20px;
    }

    .product-info h3 {
      color: #00d9ff;
      margin-bottom: 8px;
    }

    .product-info .price {
      font-size: 1.3rem;
      color: #51cf66;
      font-weight: bold;
    }

    /* Infinite Scroll */
    .load-more-sentinel {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .loading {
      color: #00d9ff;
    }

    /* Stats Section */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 50px 0;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.5s ease;
    }

    .stat-card.visible {
      opacity: 1;
      transform: scale(1);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #00d9ff;
    }

    .stat-number.counting {
      color: #ffc107;
    }

    /* Section Headers */
    .section-title {
      font-size: 1.8rem;
      color: #00d9ff;
      margin: 40px 0 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(0, 217, 255, 0.3);
    }

    /* Debug Panel */
    .debug-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #00d9ff;
      font-size: 12px;
      min-width: 200px;
    }

    .debug-panel h4 {
      color: #00d9ff;
      margin-bottom: 10px;
    }

    .debug-item {
      margin: 5px 0;
      color: #888;
    }

    .debug-item span {
      color: #51cf66;
    }
  </style>
</head>

<body>
  <!-- Header Sentinel (Invisible) -->
  <div class="header-sentinel" id="headerSentinel"></div>

  <!-- Sticky Header -->
  <header class="header" id="header">
    <h1>üõí E-Commerce Demo</h1>
  </header>

  <div class="container">
    <h2 class="section-title">üìä Platform Stats</h2>

    <!-- Stats with Count Animation -->
    <div class="stats-section">
      <div class="stat-card" data-target="15000">
        <div class="stat-number">0</div>
        <p>Products</p>
      </div>
      <div class="stat-card" data-target="50000">
        <div class="stat-number">0</div>
        <p>Customers</p>
      </div>
      <div class="stat-card" data-target="99">
        <div class="stat-number">0</div>
        <p>% Satisfaction</p>
      </div>
    </div>

    <h2 class="section-title">üõçÔ∏è Featured Products</h2>

    <!-- Product Grid (Lazy Load + Scroll Animation) -->
    <div class="product-grid" id="productGrid">
      <!-- Products will be loaded here -->
    </div>

    <!-- Infinite Scroll Sentinel -->
    <div class="load-more-sentinel" id="loadMoreSentinel">
      <span>Scroll for more...</span>
    </div>
  </div>

  <!-- Debug Panel -->
  <div class="debug-panel">
    <h4>üîç Observer Debug</h4>
    <div class="debug-item">Header: <span id="debugHeader">Normal</span></div>
    <div class="debug-item">Visible Cards: <span id="debugCards">0</span></div>
    <div class="debug-item">Loaded Images: <span id="debugImages">0</span></div>
    <div class="debug-item">Total Products: <span id="debugTotal">0</span></div>
  </div>

  <script>
    /**
     * ============================================
     * INTERSECTION OBSERVER - PRODUCTION EXAMPLE
     * 4 YEARS EXPERIENCE INTERVIEW LEVEL
     * ============================================
     * 
     * Yeh example 4 real-world use cases demonstrate karta hai:
     * 1. Sticky Header Detection
     * 2. Lazy Loading Images
     * 3. Scroll Animations
     * 4. Infinite Scroll
     * 5. Count Up Animation on Visibility
     */

    // ============================================
    // 1. STICKY HEADER OBSERVER
    // ============================================
    /**
     * Header Sentinel Pattern:
     * - Ek invisible element (sentinel) page top pe rakhte hain
     * - Jab sentinel viewport se bahar jaaye = user ne scroll kiya
     * - Header ko sticky style apply karo
     */

    const headerObserver = new IntersectionObserver(
      (entries) => {
        const header = document.getElementById('header');
        // Agar sentinel visible NAHI hai = scrolled
        const isScrolled = !entries[0].isIntersecting;
        header.classList.toggle('scrolled', isScrolled);
        document.getElementById('debugHeader').textContent = isScrolled ? 'Scrolled ‚úì' : 'Normal';
      },
      { threshold: 0 }
    );

    headerObserver.observe(document.getElementById('headerSentinel'));


    // ============================================
    // 2. PRODUCT CARD OBSERVER (Animation + Lazy Load)
    // ============================================
    /**
     * Combined Observer for:
     * - Fade-in animation jab card visible ho
     * - Image lazy loading with loading spinner
     * - Unobserve after animation (performance)
     */

    let visibleCardCount = 0;
    let loadedImageCount = 0;

    const productObserver = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const card = entry.target;

            // 1. Add visible class for animation
            card.classList.add('visible');
            visibleCardCount++;

            // 2. Lazy load image
            const imageContainer = card.querySelector('.product-image');
            if (imageContainer && !imageContainer.classList.contains('loaded')) {
              // Simulate image loading
              setTimeout(() => {
                imageContainer.classList.add('loaded');
                loadedImageCount++;
                document.getElementById('debugImages').textContent = loadedImageCount;
              }, 300 + Math.random() * 500);
            }

            // 3. Unobserve - ek baar animate ho gaya, ab zaroorat nahi
            observer.unobserve(card);

            document.getElementById('debugCards').textContent = visibleCardCount;
          }
        });
      },
      {
        threshold: 0.2,      // 20% visible hone pe trigger
        rootMargin: '50px'   // 50px pehle se load shuru karo
      }
    );


    // ============================================
    // 3. STATS COUNT-UP OBSERVER
    // ============================================
    /**
     * Jab stats section visible ho:
     * - Numbers 0 se target tak count-up animation
     * - Sirf ek baar animate karo
     */

    const statsObserver = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const card = entry.target;
            card.classList.add('visible');

            // Count-up animation
            const numberEl = card.querySelector('.stat-number');
            const target = parseInt(card.dataset.target);
            animateCount(numberEl, target);

            observer.unobserve(card);
          }
        });
      },
      { threshold: 0.5 }
    );

    function animateCount(element, target) {
      element.classList.add('counting');
      const duration = 2000; // 2 seconds
      const steps = 60;
      const increment = target / steps;
      let current = 0;

      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          element.textContent = target.toLocaleString();
          element.classList.remove('counting');
          clearInterval(timer);
        } else {
          element.textContent = Math.floor(current).toLocaleString();
        }
      }, duration / steps);
    }

    // Apply to all stat cards
    document.querySelectorAll('.stat-card').forEach(card => {
      statsObserver.observe(card);
    });


    // ============================================
    // 4. INFINITE SCROLL OBSERVER
    // ============================================
    /**
     * Sentinel Pattern for Infinite Scroll:
     * - Page ke bottom pe ek invisible sentinel element
     * - Jab sentinel visible ho = user end tak scroll kar gaya
     * - Aur products load karo
     */

    let currentPage = 0;
    let isLoading = false;
    const productsPerPage = 6;

    const infiniteScrollObserver = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting && !isLoading) {
          loadMoreProducts();
        }
      },
      {
        threshold: 0.1,
        rootMargin: '100px'  // 100px pehle se load karo (smooth experience)
      }
    );

    infiniteScrollObserver.observe(document.getElementById('loadMoreSentinel'));


    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    const productEmojis = ['üëü', 'üëï', 'üëñ', 'üëú', '‚åö', 'üéß', 'üì±', 'üíª', 'üéÆ', 'üì∑'];
    const productNames = ['Shoes', 'T-Shirt', 'Jeans', 'Bag', 'Watch', 'Headphones', 'Phone', 'Laptop', 'Console', 'Camera'];

    function createProductCard(index) {
      const randomIndex = Math.floor(Math.random() * productEmojis.length);
      const price = (Math.random() * 10000 + 500).toFixed(0);

      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
                <div class="product-image">
                    <div class="loader"></div>
                    <span style="position: relative; z-index: 1;">${productEmojis[randomIndex]}</span>
                </div>
                <div class="product-info">
                    <h3>${productNames[randomIndex]} #${index}</h3>
                    <p>Premium quality product with excellent reviews</p>
                    <p class="price">‚Çπ${parseInt(price).toLocaleString()}</p>
                </div>
            `;
      return card;
    }

    function loadMoreProducts() {
      if (currentPage >= 5) {
        document.getElementById('loadMoreSentinel').innerHTML = '‚úÖ All products loaded!';
        infiniteScrollObserver.disconnect();
        return;
      }

      isLoading = true;
      const sentinel = document.getElementById('loadMoreSentinel');
      sentinel.innerHTML = '<span class="loading">‚è≥ Loading...</span>';

      // Simulate API call delay
      setTimeout(() => {
        const grid = document.getElementById('productGrid');

        for (let i = 0; i < productsPerPage; i++) {
          const productIndex = currentPage * productsPerPage + i + 1;
          const card = createProductCard(productIndex);
          grid.appendChild(card);

          // Observe new card for animation
          productObserver.observe(card);
        }

        currentPage++;
        isLoading = false;
        sentinel.innerHTML = '<span>Scroll for more...</span>';

        document.getElementById('debugTotal').textContent = currentPage * productsPerPage;
      }, 800);
    }

    // Initial load
    loadMoreProducts();


    // ============================================
    // INTERVIEW NOTES (Comments for Reference)
    // ============================================
    /**
     * IMPORTANT POINTS FOR 4 YEARS INTERVIEW:
     * 
     * 1. PERFORMANCE OPTIMIZATION:
     *    - unobserve() use karo jab element handle ho jaaye
     *    - rootMargin use karo preloading ke liye
     *    - Single observer for similar elements (batch processing)
     * 
     * 2. THRESHOLD VALUES:
     *    - 0: 1px bhi dikhe toh trigger
     *    - 0.5: 50% visible hone pe
     *    - 1: 100% visible hone pe
     *    - [0, 0.5, 1]: Multiple points pe callback
     * 
     * 3. ROOT MARGIN:
     *    - Positive: Viewport se bahar bhi observe (preload)
     *    - Negative: Viewport ke andar aane ke baad observe
     * 
     * 4. COMMON MISTAKES:
     *    - Observer.disconnect() bhool jana (memory leak)
     *    - Har scroll pe heavy operations karna
     *    - Threshold samajhna
     * 
     * 5. BROWSER SUPPORT:
     *    - All modern browsers supported
     *    - IE ke liye polyfill chahiye
     *    - Safari mein kuch quirks hain
     * 
     * 6. ALTERNATIVES (Why IO is better):
     *    - scroll event + getBoundingClientRect() = expensive
     *    - IntersectionObserver = async, off main thread
     */

    console.log('IntersectionObserver Demo Ready!');
    console.log('Scroll karo aur debug panel dekho!');
  </script>
</body>

</html>